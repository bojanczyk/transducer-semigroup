
\input{abstract-sst}

\subparagraph*{Coproducts and views.}
\label{sec:coproducts-and-views}

Apart from the more abstract transducer model from Definition~\ref{def:functorial-sst}, the other ingredient used  in the proof of the hard implication in Theorem~\ref{thm:regular-functions} will be coproducts of semigroups, and some basic operations on them, as described in this section.

We write $1$ for the semigroup that has one element. This semigroup is unique up to isomorphism and it is a \emph{terminal object} in the category of semigroups, which means that it admits a unique homomorphism from every other semigroup $A$. This unique homomorphism will be denoted by $!\colon A \to 1$. It has no connection with the factorial function on numbers. 

The \emph{coproduct}  of two semigroups $A$ and $B$, denoted by $A \oplus B$, is the semigroup whose elements are nonempty words over an alphabet that is the disjoint union of $A$ and $B$, restricted to words that are \emph{alternating} in the sense that two consecutive letters cannot belong to the same semigroup. The semigroup operation is defined in the expected way. We draw elements of a coproduct using coloured boxes, with the following picture showing the product operation in the coproduct of two copies, \red{red} and \blue{blue}, of the semigroup $\set{a,b}^+$:
\begin{align*}
    (\red{\boxed{aba}} \cdot 
    \blue{\boxed{b}} \cdot 
    \red{\boxed{b}} \cdot 
    \blue{\boxed{aa}}) \cdot 
    (
        \blue{\boxed{abba}} \cdot 
        \red{\boxed{aa}} \cdot 
        \red{\boxed{bb}}
    )
    = 
\red{\boxed{aba}} \cdot 
    \blue{\boxed{b}} \cdot 
    \red{\boxed{b}} \cdot 
    \blue{\boxed{aaabba}} \cdot 
        \red{\boxed{aa}} \cdot 
        \red{\boxed{bb}}.
\end{align*}
A coproduct can involve more than two semigroups; in the pictures this would correspond to more colours, subject to the condition that  consecutive boxes have different colours.
\begin{remark}
  The copyless register updates $u : R \to (A + R)^+$ of ordinary \sst{}s that are in normal form according to the definition of \Cref{sec:easy} can be seen as maps
  \[ R \to A \oplus \bigoplus_{X\in R} \{X\}^+ \]
\end{remark}
% The name \emph{coproduct} is used because of the following universal property: if
% \begin{align*}
% f : A \to C \qquad \text{and} \qquad g : B \to C
% \end{align*}
% are two semigroup homomorphisms, then
% there is a unique homomorphism 
% \[
% \begin{tikzcd}
% f \text{ or } g : A \oplus B \to C
% \end{tikzcd}
% \]
% that coincides with $f$ (resp.~$g$) on the subsemigroup of $A \oplus B$ consisting of words with a single letter from $A$ (resp.~$B$).






\begin{remark}[used in our proof]
    \label{rem:coproduct-as-polynomial-functor}
    %The polynomial functors that we  use in our proof will arise using coproducts with the singleton semigroup $1$. 
    Consider the semigroup-to-set functor $A \mapsto A \oplus 1$, which maps a semigroup to the underlying set of its coproduct with the singleton semigroup. Although not defined as a polynomial functor, this functor is isomorphic to one. This is because for every semigroup $A$ there is a bijective correspondence between the sets
    \begin{align*}%\label{eq:polynomial-representation-of-coproduct}
    A \oplus 1 \quad \text{and} \quad \coprod_{q \in 1 \oplus 1} A^{\text{dimension of $q$}},
    \end{align*}
    where the dimension of $q$ is defined to be the number of times that the first copy of $1$ appears in $q$. Furthermore, this bijection is natural, and thus we can speak of $A \oplus 1$ as being a polynomial functor. This remark applies to similar constructions, which involve a coproduct of several copies of $A$ with several copies of $1$, such as $A \oplus A \oplus A \oplus 1 \oplus 1$.
    %Mikolaj: I eliminated parts of this discussion, since they can be inserted (in the reader's head) at the places where they are used
    % bijection in~\eqref{eq:polynomial-representation-of-coproduct} is natural, and therefore there is a natural bijection between the functor $(-) \oplus 1$ and some polynomial functor. Also, if two polynomial functors are connected by a natural bijection, then they are the same, up to renaming of the components, and therefore the representation in~\eqref{eq:polynomial-representation-of-coproduct} is unique up to renaming of components. By uniqueness, we will simply speak of $A \oplus 1$ as being a polynomial functor.  In a similar way, functors such as $A \mapsto A \oplus 1 \oplus A$ are also polynomial.
    % Noting that $\oplus$ makes sense as an operation on sets without a semigroup structure (it builds a set of nonempty alternating sequences), we have more generally that, if $\functor$ is a polynomial functor, then so is $A \mapsto \functor A \oplus 1$. 
\end{remark}







% \begin{example}\label{ex:copyless-on-coproducts}
%     Consider the functor \enquote{$A\mapsto$ underlying set of $A \oplus 1$} from Example~\ref{ex:coproduct-as-polynomial-functor}, which was shown to be a polynomial functor. The natural transformation in $A$
%     \begin{align*}
%     (A \oplus 1)\times (A \oplus 1) \longrightarrow A \oplus 1
%     \end{align*}
%     which describes the semigroup operation in the coproduct $A \oplus 1$ is copyless.
% \end{example}


% \subsubsection{Views}
% \label{sec:views}

The crucial property of semigroups that will be used in our proof is described in Lemma~\ref{lem:views} below, which says that an element of a coproduct can be reconstructed based on certain partial information. This information is described  using the following operations.

\begin{enumerate}
    \item \textbf{Merging}. Consider a coproduct $A_1 \oplus \cdots \oplus A_n$, such that the same semigroup $A$ appears on all coordinates from a subset $I \subseteq \set{1,\ldots,n}$, and possibly on other coordinates as well. Define \emph{merging the parts from $I$} to be the function of type 
    \begin{align*}
        A_1 \oplus \cdots \oplus A_n \to  A \oplus \bigoplus_{i \not \in I} A_i
        \end{align*}
    that is defined in the expected way, and explained in the following picture. In the picture, merging is applied to  a coproduct of three copies of the semigroup $\set{a,b}^+$, indicated using colours \red{red}, black and \blue{blue}, and the merged coordinates are \red{red} and \blue{blue}:
        \begin{align*}
        \blue{\boxed{aba}} \cdot 
        \red{\boxed{b}} \cdot 
        \boxed{aa} \cdot 
        \red{\boxed{b}} \cdot 
        \blue{\boxed{aa}} \cdot 
        \red{\boxed{abba}} \cdot 
        \boxed{b}
        \quad \mapsto \quad  
        \myunderbrace{
            \violet{\boxed{abab}} \cdot 
        \boxed{aa} \cdot 
        \violet{\boxed{baaabba}} \cdot 
        \boxed{b}
        }{the merge of \red{red} and \blue{blue} is drawn in \violet{violet}}.\end{align*}    
        \item \textbf {Shape.}  Define the \emph{shape operation} to be the function of type 
        \begin{align*}
        A_1 \oplus \cdots \oplus A_n \to 1 \oplus \cdots \oplus 1
        \end{align*}
        obtained by applying $!$ on every coordinate. The shape says how many alternating blocks there are, and which semigroups they come from, as explained in the following picture:
        \begin{align*}
            \blue{\boxed{aba}} \cdot 
            \red{\boxed{b}} \cdot 
            \boxed{aa} \cdot 
            \red{\boxed{b}} \cdot 
            \blue{\boxed{aa}} \cdot 
            \red{\boxed{abba}} \cdot 
            \boxed{b}
            \quad \mapsto \quad  
            \blue{\boxed{1}} \cdot 
            \red{\boxed{1}} \cdot 
            \boxed{1} \cdot 
            \red{\boxed{1}} \cdot 
            \blue{\boxed{1}} \cdot 
            \red{\boxed{1}} \cdot 
            \boxed{1}.
        \end{align*}
        \item \textbf{Views.} The final operation is the $i$-th view 
        \begin{align*}
        A_1 \oplus \cdots \oplus A_n \to 1 \oplus A_i.
        \end{align*}
        This operation applies $!$ to all coordinates other than $i$, and then it merges all those coordinates. Here is a picture, in which we take the view of the \blue{blue} coordinate:
        \begin{align*}
            \blue{\boxed{aba}} \cdot 
            \red{\boxed{b}} \cdot 
            \boxed{aa} \cdot 
            \red{\boxed{b}} \cdot 
            \blue{\boxed{aa}} \cdot 
            \red{\boxed{abba}} \cdot 
            \boxed{b}
            \quad \mapsto \quad  
            \blue{\boxed{aba}} \cdot 
            {\boxed{1}} \cdot 
            \blue{\boxed{aa}} \cdot 
            \boxed{1}.
        \end{align*}
        
\end{enumerate}


% Another crucial property of the coproduct of semigroups is that a coproduct can be reconstructed from certain partial information, as described below. 
% Consider a coproduct $A_1 \cdots A_n$.


The key observation is that an element of a coproduct can be reconstructed from its shape and views, as stated in the following lemma. 

\begin{proposition}
\label{prop:views} Let $A_1,\ldots,A_n$ be semigroups. The \emph{deconstruction} function of type
\begin{align*}
A_1 \oplus \cdots \oplus A_n \longrightarrow (1 \oplus A_1) \times \cdots \times (1 \oplus A_n) \times (1 \oplus \cdots \oplus 1),
\end{align*}
which is obtained by combining the views for all $i \in \set{1,\ldots,n}$ and the shape, is injective. 
\end{proposition}
\begin{proof}
    The input can be reconstructed from the output as follows.
    Start with the shape, and replace the entries from $1$ with the semigroup elements used in the views.
\end{proof}
This lemma seems to contain the essential property of semigroups that makes the construction work. We expect our theorem to also be true for other algebraic structures for which the lemma is true; however, the lemma seems to fail for certain algebraic structures. Concrete examples will be discussed in the conclusion (\Cref{sec:conclusion}).

Like any injective function, deconstruction admits a partial left inverse: a function
    \[ \qquad (1 \oplus A_1) \times \cdots \times (1 \oplus A_n) \times (1 \oplus \cdots
  \oplus 1) \longrightarrow (A_1 \oplus \cdots \oplus A_n) + 1 \]
such that deconstruction followed by this function maps every element of $A_1 \oplus \cdots \oplus A_n$ to itself.
We call \emph{reconstruction} the unique left inverse that sends any input not in the image of deconstruction to the right component $1$. Then from the argument proving \Cref{prop:views}, one can also derive the following (which makes sense thanks to \Cref{rem:coproduct-as-polynomial-functor}).
\begin{lemma}\label{lem:reconstruction}
  When each $A_i$ is either $A$ or $1$, reconstruction can be seen as a \emph{copyless natural} function between polynomial functors in $A$.
\end{lemma}
